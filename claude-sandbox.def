Bootstrap: docker
From: node:22-slim

%labels
    Author nrbosch
    Description Claude Code Sandbox

%post
    export DEBIAN_FRONTEND=noninteractive

    apt-get update && apt-get install -y --no-install-recommends \
        git git-lfs curl wget tmux ca-certificates gnupg \
        python3 python3-pip python3-venv bash \
        g++ make \
        procps \
        sqlite3 libsqlite3-dev \
        texlive-latex-base texlive-latex-recommended texlive-latex-extra latexmk \
        bsdmainutils tree file less jq zip unzip rsync xz-utils \
        && rm -rf /var/lib/apt/lists/*

    # GitHub CLI
    curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | \
        dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
    echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | \
        tee /etc/apt/sources.list.d/github-cli.list > /dev/null
    apt-get update && apt-get install -y gh && rm -rf /var/lib/apt/lists/*

    # uv (Python package manager)
    curl -LsSf https://astral.sh/uv/install.sh | sh
    mv /root/.local/bin/uv /usr/local/bin/
    mv /root/.local/bin/uvx /usr/local/bin/

    # Typst (document compiler)
    curl -fsSL https://github.com/typst/typst/releases/latest/download/typst-x86_64-unknown-linux-musl.tar.xz | \
        tar -xJ --wildcards --strip-components=1 -C /usr/local/bin/ '*/typst'

    # ccstatusline (for tmux status line)
    npm install -g ccstatusline

%environment
    export PATH="/usr/local/bin:$HOME/.local/bin:$PATH"
    export UV_TOOL_DIR="$HOME/.local/share/uv/tools"
    export UV_TOOL_BIN_DIR="$HOME/.local/bin"
    export UV_PROJECT_ENVIRONMENT=.venv-sandbox

%runscript
    # Install Claude Code on first run (enables auto-updates)
    if [ ! -x "$HOME/.local/bin/claude" ]; then
        echo "Installing Claude Code..."
        curl -fsSL https://claude.ai/install.sh | bash -s latest
    fi
    exec "$HOME/.local/bin/claude" "$@"
